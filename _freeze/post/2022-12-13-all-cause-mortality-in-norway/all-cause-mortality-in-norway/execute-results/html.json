{
  "hash": "bfb62ac8a0f22c4706fdb0ca4c6f46fe",
  "result": {
    "markdown": "---\ntitle: \"All-Cause Mortality in Norway\"\ndescription: |\n  Examining all-cause mortality in Norway using publically available mortality data from SSB.\nauthor:\n  - name: \"Richard Aubrey White\"\n    url: https://www.rwhite.no\n    orcid: 0000-0002-6747-1726\ndate: 2022-12-13\ntitle-block-banner: \"#b8e2f2\"\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(magrittr)\nlibrary(ggplot2)\n\nif (interactive()) {\n  folder_location <- \"post/2022-12-13-all-cause-mortality-in-norway/\"\n} else {\n  folder_location <- \"\"\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Downloading data\ndata <- PxWebApiData::ApiData(\n  \"https://data.ssb.no/api/v0/en/table/07995\",\n  Kjonn = \"0\",\n  Alder = \"999A\",\n  Tid = as.character(2000:2022),\n  Uke = paste0(\"U\", formatC(1:52, width = 2, flag = \"0\"))\n)\n\n# Cleaning\nd_deaths <- data$dataset[, c(\"Uke\", \"Tid\", \"value\")]\nsetDT(d_deaths)\nsetnames(d_deaths, c(\"week\", \"isoyear\", \"deaths_n\"))\nd_deaths[, isoweek := stringr::str_remove(week, \"U\")]\nd_deaths[, isoyearweek := paste0(isoyear, \"-\", isoweek)]\nd_deaths[, isoweek := as.numeric(isoweek)]\nd_deaths[, isoyear := as.numeric(isoyear)]\nd_deaths[, week := NULL]\nsetcolorder(d_deaths, c(\"isoyear\", \"isoweek\", \"isoyearweek\", \"deaths_n\"))\n\n# Removing the latest 3 weeks of data (due to registration delay)\nmax_isoweek <- d_deaths[isoyear == 2022 & !is.na(deaths_n)]$isoweek %>%\n  max() - 3\nd_deaths <- d_deaths[isoweek <= max_isoweek]\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregating\npd <- d_deaths[, .(deaths_n = sum(deaths_n)), keyby = .(isoyear)]\n\n# Plotting\nq <- ggplot(pd, aes(x = isoyear, y = deaths_n))\nq <- q + geom_line()\nq <- q + geom_point()\nq <- q + scale_x_continuous(\n  \"Isoyear\",\n  breaks = seq(2000, 2022, 2)\n  )\nq <- q + scale_y_continuous(\n  \"Number of deaths\",\n  labels = csstyle::format_nor_num_0,\n  breaks = seq(33000, 38000, 1000)\n)\nq <- q + expand_limits(y = c(33000, 38000))\nq <- q + labs(\n    title = glue::glue(\n      \"Deaths in Norway, occurring between isoweeks 1 and {max_isoweek} (inclusive)\"\n    )\n  )\nq <- q + labs(caption = \"Data extracted 2022-12-13 from SSB table 07995.\")\nq\n```\n\n::: {.cell-output-display}\n![](all-cause-mortality-in-norway_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Estimating the baseline\nsetorder(d_deaths, isoyearweek)\nfor(isoyear_pred in 2011:2022) for(isoweek_model in unique(d_deaths$isoweek)){\n\n  # Determining the training data\n  if(isoyear_pred <= 2019){\n    isoyear_train <- (isoyear_pred-10):(isoyear_pred-1)\n  } else {\n    isoyear_train <- 2010:2019\n  }\n  \n  # Fitting the model\n  fit <- glm(\n    deaths_n ~ isoyear, \n    data = d_deaths[isoweek %in% isoweek_model & isoyear %in% isoyear_train],\n    family = \"poisson\"\n  )\n  \n  # Predicting the baseline\n  pred <- predict(\n      fit, \n      d_deaths[isoweek %in% isoweek_model & isoyear %in% isoyear_pred]\n    ) %>% \n    exp()\n  d_deaths[\n    isoweek %in% isoweek_model & isoyear %in% isoyear_pred, \n    deaths_baseline_n := pred\n  ]\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculating the excess mortality\nd_deaths[, deaths_excess_n := deaths_n - deaths_baseline_n]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregating\npd <- d_deaths[\n  !is.na(deaths_excess_n),\n  .(deaths_excess_n = sum(deaths_excess_n)), \n  keyby = .(isoyear)\n]\n\n# Plotting\nq <- ggplot(pd, aes(x = isoyear, y = deaths_excess_n))\nq <- q + geom_col()\nq <- q + geom_hline(yintercept = 0, color = \"black\")\nq <- q + scale_x_continuous(\n  \"Isoyear\",\n  breaks = seq(2011, 2022, 1)\n  )\nq <- q + scale_y_continuous(\n  \"Number of excess deaths\",\n  labels = csstyle::format_nor_num_0,\n  breaks = seq(-1000, 4000, 500)\n)\nq <- q + labs(\n    title = glue::glue(\n      \"Excess deaths in Norway, occurring between isoweeks 1 and {max_isoweek} (inclusive)\"\n    )\n  )\nq <- q + labs(\n  caption = \"Weekly baseline calculated from a poisson regression of the previous 10 years of data.\\nBaselines for 2020, 2021, and 2022 calculated using data for 2010-2019.\\nData extracted 2022-12-13 from SSB table 07995.\"\n)\nq\n```\n\n::: {.cell-output-display}\n![](all-cause-mortality-in-norway_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n",
    "supporting": [
      "all-cause-mortality-in-norway_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}