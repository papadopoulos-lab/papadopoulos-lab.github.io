{
  "hash": "059ec9c428686d3c8888945f073c229b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All-Cause Mortality in Norway\"\ndescription: |\n  Examining all-cause mortality in Norway using publically available mortality data from SSB.\nauthor:\n  - name: \"Richard Aubrey White\"\n    url: https://www.rwhite.no\n    orcid: 0000-0002-6747-1726\ndate: 2023-08-26\ntitle-block-banner: \"#b8e2f2\"\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(magrittr)\nlibrary(ggplot2)\n\nif (interactive()) {\n  folder_location <- \"post/2023-08-26-all-cause-mortality-in-norway/\"\n} else {\n  folder_location <- \"\"\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Downloading data\nd_deaths <- fread(\"https://data.ssb.no/api/v0/dataset/932937.csv?lang=en\")\nsetnames(d_deaths, c(\"sex\", \"age\", \"week\", \"content\", \"deaths_n\"))\nd_deaths[, isoweek := stringr::str_extract(week, \"[0-9][0-9]$\")]\nd_deaths[, isoyear := stringr::str_extract(week, \"^[0-9][0-9][0-9][0-9]\")]\nd_deaths[, isoyearweek := paste0(isoyear, \"-\", isoweek)]\nd_deaths[, isoweek := as.numeric(isoweek)]\nd_deaths[, isoyear := as.numeric(isoyear)]\nd_deaths[, week := NULL]\nd_deaths <- d_deaths[isoyear >= 2004]\nd_deaths <- d_deaths[sex==\"0 Both sexes\"]\nd_deaths[, sex := NULL]\nd_deaths[, content := NULL]\nsetcolorder(d_deaths, c(\"age\", \"isoyear\", \"isoweek\", \"isoyearweek\", \"deaths_n\"))\nsetorder(d_deaths, age, isoyearweek)\n# Removing the latest 3 weeks of data (due to registration delay)\nmax_isoweek <- d_deaths[isoyear == 2023 & !is.na(deaths_n)]$isoweek %>%\n  max() - 3\nd_deaths <- d_deaths[isoweek <= max_isoweek]\n\n# recategorizing age\nunique(d_deaths$age)\nd_deaths[, age := fcase(\n  age == \"F00-04 0-4 years\", \"0-19\",\n  age == \"F05-09 5-9 years\", \"0-19\",\n  age == \"F10-14 10-14 years\", \"0-19\",\n age == \"F15-19 15-19 years\", \"0-19\",\n age == \"F20-24 20-24 years\", \"20-39\",\n age == \"F25-29 25-29 years\", \"20-39\",\n age == \"F30-34 30-34 years\", \"20-39\",\n age == \"F35-39 35-39 years\", \"20-39\",\n age == \"F40-44 40-44 years\", \"40-59\",\n age == \"F45-49 45-49 years\", \"40-59\",\n age == \"F50-54 50-54 years\", \"40-59\",\n age == \"F55-59 55-59 years\", \"40-59\",\n age == \"F60-64 60-64 years\", \"60-69\",\n age == \"F65-69 65-69 years\", \"60-69\",\n age == \"F70-74 70-74 years\", \"70-79\",\n age == \"F75-79 75-79 years\", \"70-79\",\n age == \"F80-84 80-84 years\", \"80-89\",\n age == \"F85-89 85-89 years\", \"80-89\",\n age == \"F90-94 90-94 years\", \"90+\",\n age == \"F95-99 95-99 years\", \"90+\",\n age == \"F100G5+ 100 years or older\", \"90+\"\n)]\nd_deaths <- d_deaths[,.(\n  deaths_n = sum(deaths_n)\n), keyby=.(\n  age, isoyear, isoweek, isoyearweek\n)]\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregating\npd <- d_deaths[, .(deaths_n = sum(deaths_n)), keyby = .(isoyear, age)]\npd[\n  csdata::nor_population_by_age_cats(list(\"0-19\"=0:19, \"20-39\"=20:39, \"40-59\"=40:59, \"60-69\"=60:69, \"70-79\"=70:79, \"80-89\"=80:89, \"90+\"=90:110))[granularity_geo==\"nation\"],\n  on = c(\"isoyear==calyear\", \"age\"),\n  pop_jan1_n := pop_jan1_n\n  ]\npd[, deaths_pr1000000 := 1000000*deaths_n/pop_jan1_n]\n\n# Estimating the baseline\nfor(x_age in unique(pd$age))for(isoyear_pred in 2011:2023){\n\n  # Determining the training data\n  if(isoyear_pred <= 2019){\n    isoyear_train <- (isoyear_pred-5):(isoyear_pred-1)\n  } else {\n    isoyear_train <- 2010:2019\n  }\n  \n  # Fitting the model\n  fit <- glm(\n    deaths_n ~ isoyear + offset(log(pop_jan1_n)), \n    #deaths_n ~ isoyear, \n    data = pd[age %in% x_age & isoyear %in% isoyear_train],\n    family = \"poisson\"\n  )\n  \n  # Predicting the baseline\n  pred <- predict(\n      fit, \n      pd[age %in% x_age & isoyear %in% isoyear_pred]\n    ) %>% \n    exp()\n  pd[\n    age %in% x_age & isoyear %in% isoyear_pred, \n    deaths_baseline_n := pred\n  ]\n}\n\n# Calculating the excess mortality\npd[, deaths_baseline_pr1000000 := 1000000*deaths_baseline_n/pop_jan1_n]\npd[, deaths_excess_n := deaths_n - deaths_baseline_n]\npd[, deaths_excess_pr100 := 100*deaths_excess_n/deaths_baseline_n]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plotting\nq <- ggplot(pd, aes(x = isoyear, y = deaths_pr1000000))\nq <- q + annotate(\"rect\", xmin=2019.5, xmax=Inf, ymin=-Inf,ymax=Inf, fill=\"red\", alpha = 0.2)\nq <- q + geom_line(mapping = aes(y=deaths_baseline_pr1000000, color = \"Baseline\"), lwd = 2, alpha = 0.8)\nq <- q + geom_line(mapping=aes(color=\"Observed\"))\nq <- q + geom_point(mapping=aes(color=\"Observed\"))\nq <- q + scale_x_continuous(\n  \"Isoyear\",\n  breaks = seq(2000, 2023, 2)\n  )\nq <- q + scale_color_manual(NULL, values=c(\"green\", \"black\"))\nq <- q + scale_y_continuous(\"Deaths per 1 000 000 population\")\nq <- q + facet_wrap(~age, scales = \"free_y\")\nq <- q + labs(\n    title = glue::glue(\n      \"Deaths in Norway, occurring between isoweeks 1 and {max_isoweek} (inclusive)\"\n    )\n  )\nq <- q + labs(caption = \"Data extracted 2023-08-29 from SSB table 932937.\")\nq <- q + csstyle::set_x_axis_vertical()\nq\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 7 rows containing missing values (`geom_line()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](all-cause-mortality-in-norway_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Plotting\nq <- ggplot(pd, aes(x = isoyear, y = deaths_excess_pr100))\nq <- q + annotate(\"rect\", xmin=2019.5, xmax=Inf, ymin=-Inf,ymax=Inf, fill=\"red\", alpha = 0.2)\nq <- q + geom_col()\nq <- q + geom_hline(yintercept = 0, color = \"black\")\nq <- q + scale_x_continuous(\n  \"Isoyear\",\n  breaks = seq(2011, 2023, 1)\n  )\nq <- q + facet_wrap(~age)\nq <- q + scale_y_continuous(\"Percentage excess (%)\")\n# q <- q + scale_y_continuous(\n#   \"Number of excess deaths\",\n#   labels = csstyle::format_num_as_nor_num_0,\n#   breaks = seq(-1000, 4000, 500)\n# )\nq <- q + labs(\n    title = glue::glue(\n      \"Excess deaths in Norway, occurring between isoweeks 1 and {max_isoweek} (inclusive)\"\n    )\n  )\nq <- q + labs(\n  caption = \"Baseline calculated from a poisson regression of the previous 10 years of data.\\nBaselines for 2020, 2021, and 2022 calculated using data for 2010-2019.\\nData extracted 2023-08-29 from SSB table 932937.\"\n)\nq <- q + csstyle::set_x_axis_vertical()\nq\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 49 rows containing missing values (`position_stack()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](all-cause-mortality-in-norway_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n",
    "supporting": [
      "all-cause-mortality-in-norway_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}